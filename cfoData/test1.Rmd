---
title: "April, 2017 - July 2017 Stats And Methods"
author: "Martin Gleason, MS"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  pdf_document:
    latex_engine: xelatex
    fig_caption: yes
  html_document: default
tables: yes
header-includes:
- \usepackage{color}
- \usepackage{float}
- \usepackage{longtable}

urlcolor: blue
---
```{r, required files, include = F, echo = F}
source("/Users/marty/Dropbox (Personal)/codingProjects/cfoData/april_julyCFO.R")

options(knitr.table.format = "latex")
opts_chunk$set(fig.pos = "h")
opts_chunk$set(message = F)
opts_chunk$set(warning = F)
```
# Purpose
This document is to summarize the last three months of CFO data, including: attendance policy, attendance numbers, referrals, JEMS issues, tracking and storing data, and data transformation. A way forward with CFOs will also be presented. While some of the tables maybe be difficult to read, thanks to the magic of PDF formats, any reader should be able to zoom into items of note. If the department wants to explore using R for stat and report generation, future editions of reports will be able to have interactive graphs.

# Attendance
Critical to the continued success of the CFO is getting the attendance rate over 50%. Traditional JAC Orientation programming reached a cap of approximately 50%, with attendance numbers typically hovering between 25%-40%. CFOs run more frequently, in a variety of times and locations, and have additional attendance tracking problems. Solutions to these issue are presented in this report.

## Attendance Policy
A carry over from traditional JAC programming, young people are referred to a CFO three times before not being eligible for the program. Where as traditional orientations did not have a referral process, CFOs do have a series of protocols inplace, including:

* Paper referrals that are given to each unit involved in CFO Programming
* Monthly lists (generated from JEMS based Excel Spreadsheets) that are given to SPOs of each unit
* Personalized form letters mailed between 5-10 days before a CFO
    + A copy of this letter is also given to POs 
    + The letter's verbage reflects the more inclusive tone of the CFO, including "encouraging young people to attend" and their PO's last name as a person to contact if they cannot make the CFO
* Phone calls 12-48 hours before a CFO
    + All phone calls are documented in JEMS
* Attendance is recorded on paper and in JEMS
    + JEMS notes are typically entered within one week of a CFO
    + Excel is not consistently used to indicate attedance
    + This is more challenging than expected, but it will be explored further in the JEMS section
  
## Attendance Numbers
Getting these numbers is problematic for a variety of reasons, not the least of which because JEMS does not track or export attendance numbers. To get the raw data for this particular report, the following was done:

1. JEMS exported 4 Excel tables
2. A new column, "Attendance" was added.
3. Paper records were consulted for determining attendance
4. Duplicate JEMS ID were removed through an Excel function

### What the data indicates
The first ten youth from the new table are as follows

```{r, numbers tables, include = T, echo = F}
april_july_CFO_attendance <- april_july_CFO_attendance %>% arrange(LNAME)

kable(head(april_july_CFO_attendance, n =10), caption = "First 10 CFO Youth in Alphabetical Order", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "scale_down", "hold_position"))
```
This first table illustrates some of the difficulties with the JEMS Data. Despite being "precleaned" in Excel, some errors remain. For example, this record:

```{r, include = T, echo = F}
kable(april_july_CFO_attendance %>% filter(FNAME == "Xavier" & LNAME == "Allen"), 
      caption = "First Duplicate Youth", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "scale_down", "hold_position"))
```
is duplicated, which inflates the number of youth counted by Excel. 

Therefore, while it appears that the table has *`r uncleaned_invited`* young people who were invited to CFOs, the actual number is *`r true_invited`*,  a difference of *`r scales::percent((uncleaned_invited - true_invited)/true_invited)`*.   

A *`r scales::percent((uncleaned_invited - true_invited)/true_invited)`* difference will probably not make or break a program. There is an even more difficult issue. Given that the bulk of the work on CFO attendance is done in Excel, these duplicate entries are also inflating attendance records. This kind of attendance error will complicate analysis and frustrate POs to no end. Fixing these duplication errors will be detailed in another section of this report.

# Attendance Analysis
Earlier this month, the PYD unit was asked to to compile a series of stats indicating attendance rates in CFOs. These numbers were painstakingly generated by handcounting rows of printed Excel tables. By loading this data into a different program a more thorough analysis can take place.

## Cleaning
Before any sort of analysis can took place, duplicate CFO entries were eliminated. Only unique JEMSIDs were used in determining attendance data. Additionally, attendance codes were changes from a mix of cases to a consistent use of title case (each word except any articles were capitialized.) While this notation has its own set of issues; specifically, for entry into excel or JEMS, numbers would be faster and more consistent for attendance codes, this function collapsed codes like "in custody" into one term to be used across all CFO data. Additionally, all of the records went through this same function, to increase the aesthic value of the report. Pretty reports are just more fun to read.

## Tables and Graphs
Once the data was cleaned, additional attendance analysis was conducted. For example, the attendance records were broken into three distinct representations an aggregrate total of attendance by code, attendance disagregated by zip code, and two bar charts representing attendance numbers:

```{r, attendance numbers, echo = F, include = T}
kable(invited %>% 
    group_by(Attended) %>%
    summarise(Attendance_Count = n()) %>%
    arrange(desc(Attendance_Count)),
    caption = "Attendance of Youth (Aggregate)",
    booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```
This is a fast summary of CFO attendance numbers. The next chart separates the numbers into attendance by zipcode and gender.
```{r, attendane by zip, echo = F, include = T, results = "asis"}
kable(invited %>% 
     group_by(ZIP, Attended) %>%
     summarise("Attendance Count by Zipcode" = n()),
     caption = "Attendance of Youth, by Zipcode",
     booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```
\newpage
Finally, two bar charts to show the same information graphically.
```{r, first attendance histogram, echo = F, include = T, fig.cap="Attendance by Zip, Seperated by Gender", fig.pos="H", fig.align= "center", fig.show = "asis"}
viridis_zip_plot
```
\newpage
```{r, second attendance histogram, echo = F, include = T, fig.cap="Attendance by Zip", fig.pos="H", fig.align= "center", fig.show = "asis"}
april_july_CFO_attendance %>%
filter(Attended != "Not Invited") %>%
       ggplot(aes(x = Attended, fill = factor(ZIP))) + 
       geom_histogram(stat = "count") +
       scale_fill_viridis(discrete = TRUE, name = "Zipcode") +
       labs(x = "Attendance Code",
                       y = "Total per Code",
                       title = "April - July 2017 CFO Data") +
        theme(axis.text.x = element_text(angle = -90)) + 
        coord_flip()
```
With a few lines of code, two tables and two graphs were drawn to show how many young people have attended CFOs since April, 2017. This analysis also indicates the following issues:

1. The attendance catagories of _`r unique(invited$Attended)`_ need clarification. Switching to numbers will improve clarity and analysis.

2. Some referrals do not have an assigned gender. This is due to human error, as these referrals appear to be added manaully to the attendance charts. 
    + JEMS needs to be updated to track non-binary youth.
    
3. The date of a CFO needs to be included on attendance forms or by JEMS queries.

4. Classifying CFO by Zipcode is a necessary evil. JEMS does not assign youth to CFO by police district, this is done manually. It is possible to have Excel group and assign by Zipcode, it is labor and intensive and not necessarily "push button repeatable."

Even this raw table points out some key trends in CFO attendance. Of the *`r true_invited`* youth invited to attend a CFO since April, only  *`r attended_total`* attended, a ratio of *`r scales::percent(as.numeric(attended_total)/true_invited)`*. Given that this is an aggragate of all the CFOs since April, it would be helpful to break these numbers down further. Without dates, it is impossible to give attendance rates per CFO; however, these attendance stats can be broken down further by zipcode (see table 5.)

```{r, attendance by zip, echo = F, include = T}
kable(zip_sex_attendance %>% 
        group_by(ZIP, SEX, Attended) %>%
        summarize(apz = n()) %>%
        rename("Attendance Rates" = apz),
      caption = "Attendance per Zip, by Gender",
      booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"), position = "center")
```
\newpage
This data is the same as graph located at figure 1. It is seperated into a tabular format. This may make it more understandable for some; however, the sheer volume of information is overwhelming. It is also difficult to display in this format without additional softawre packages (future of editions of this report, if warranted, will address long tables.) Since it is possible to seperate the tables into more refined "chunks" of information for ease of use, such tables should be created: All that is required are the parameters to observe this information. 

Presenting this is limited only by the amount of data at hand. More data, such as CFO Dates, text mining of JEMS notes for key words, or any other data from JEMS would provide a wealth of information. An example of this, Given this particular data set, is attendance rates presented by gender, zipcode, and referring probation officer (see table six at the end of this document.)

```{r, attendace by zip with percents, echo = F, include = T, results ="asis"}
kable(abz_PO %>% spread(ZIP, "Attendance Rate"), caption = "Attendance of Youth, Per Zip and Probation Officer", booktabs = T) %>%
  kable_styling(bootstrap_options = c("condensed", "bordered"),
                font_size = 8, 
                latex_options = c("striped", "hold_position", "scale_down"), 
                full_width = T)
```

# Analysis
The tables and graphs suggst a realtionship between PO, Zipcode, and Attendance. The nature of this relationship needs to be more thorougly examined, especially by including dates, to determine if any of these factors can be tweaked to increase attendance. Given that the program is only three months old, these attendance hiccups can be addressed in a variety of methods. Evidence of the relationship (that we already assumed) provides PYD additional direction for improving attendance. As helpful as this is, more information about CFOs would be helpful in determining attendance issues; specifically, is the violence in Chicago's neighborhoods affectng CFO attendance?

# Choropleth for Context
Drilling into the numbers by tables and graphs certainly helps paint the picture of who is, and is not, attending the CFOs, to answer this question, a map would be better. Given that it is possible to map the young people's addresses on file, with their attendance records, this may shed additional light on the attendance figures. Adding interactive (zoom-able) maps into a PDF is possible for future editions of this report, as is refining crime data to show case specific kinds of crime. But as of this writing, it is possible to plot referral addresses on a map of Chicago.

```{r, choropleth, echo = F, include = T, fig.pos = "H", fig.cap = "Area of CFO Referrals: Chicago", out.width = "75%", fig.show = "asis", fig.align = "center"}
include_graphics(cfo_map_file)
```
With this map, also possible to add layers of data. For example, we can pull crime data from the [City of Chicago](https://data.cityofchicago.org/Public-Safety/) and overlay that information on the referrals to see how our young people are affectd by violence in their communities. 

```{r, choropleth-contour, echo = F, include = T, fig.pos="h", fig.cap = "Crime Countour and CFO Referrals", out.width = "75%", fig.show = "asis", fig.align = "center"}
include_graphics(crime_contour)
```
This map shows the density of crime thoughout Chicago. More lines indicate a higher desinity of crime. The city's data has a total of 31 catagories of crime. Additional analysis would depened on further cleaning and refinement of this data. This work would allow help showcase density of violent crimes, property crimes, or drug-releated crimes, each of which may have an influence on CFO attendance. other layers of geographic information, such as CFO site locations, could be added to these maps to help identify more of the difficulties young people have in attending CFO programming. 

\newpage
# Summary and Solutions
Improving CFO attendace is critical to PYD, and the key to improving attendance is understanding the factors that impact each site and CFO. Analysis of the data indicates that while a majority of young people invited to CFOs do not attend the program, the proportions vary greatly between units and CFO locations. The attendance rates, when broken down by Zipcode and PO, suggests levels of buy-in that can be leveraged for improved attendance as well as future CFO programming. With this goal in mind, the following domain-specific suggestions should be implemented. These are bottom-lined as follows:

## JEMS 
1. PYD should get query-level access to JEMS
    + Failing that, the exported spreadsheet should include:
        + Dates assigned to CFOs
        + Dates a young person attended a CFO
        + Exporting the JEMSID search results to determine what kind of impact CFOs may, or may not, have had
        
2. JEMS should be able to sort by Zipcode

3. JEMS should accept multiple dates for multiple CFOs per month
    + As of this writing, it is difficult complete attendance in JEMS, given the variety of dates, locations, and the drawbacks of associating a CFO date with 

## Tracking and Storing Data
JEMS and Excel are the standard tools for: 

* Assigning youth to a CFO
    + Excel is critical for grouping by zipcode
    + Mail merging the letters mailed to youth and POs
    
* Attendance tracking
    + Attendace is hand written on printed spreadsheets
    + These notes are inputted into JEMS
    + Paper files are put in binders for indefinite storage

To improve analysis, either JEMS needs to be modified to take additional attendance conditions (Yes, No, In Custody/Adult Custody, Saftey Issues, Out of State, Not Appropriate for CFO) and export them to Excel, or the following numbers should be used in the excel spread sheets:

1. Yes
2. No
3. In Custody
4. In Adult Custody
5. No due to Saftey Conditions
6. Out of State
7. Not Appropriate for CFO

Additionally, for items 5-7, JEMS should be modified so those young people with those codes will not be required to attend additional CFOs.

Currently the department stores CFO records in Excel files, JEMS, and in binders. If JEMS is not updated to incoroprate the additional attendance records, the department should considering other digitial storage methods (specifically some sort of database, including Access or some version of SQL.)

## Reporting
While Excel and MS Word are the go-to reporting tools for this kind of work in the department currently, this report also showcases the ability of _R_ to  import, clean, and transform raw data into reportable information. Map creation in _R_ is also superior to the ability of MS Excel. The formatting drawbacks of _R_ can be mitigated by experience and by creating department specific reporting templates. This goes beyond the scope of this report, but if the department was interested in using these free tools, significant resources are available for support and training. 
\newpage

# Bottomline
CFOs are the future of youth led programming. To properly expand and assess CFOs, additional data analysis tools are required. Since April, 2017:

* *`r true_invited`* young people were invited to attend CFOs
* CFOs covered the following zipcodes *60827, 60617, 60621, 60628, 60636, 60619, 60649, 60651, 60644*
* The attendance ratio is a *`r scales::percent(as.numeric(attended_total)/true_invited)`*, with a significant degree of variance between POs and Zipcodes.

Furthermore, MS Excel is currently necessary for notifying clients and POs about the CFO date; however, analysis should be done in the _R_ computer lanauage. This will cut down on the time it takes to generate reports, as both the statistics and the reports can generated straight from _R_. This langauge also allows for fast and easy graphs, including maps of crime data. Where as CFOs are the future of youth led reporting, _R_ should be the future of research division of the department.